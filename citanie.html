<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <title>Načítanie QR kódu psa</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <style>
    canvas { display: none; }
  </style>
</head>
<body class="bg-light p-4">
  <div class="container">
    <h1 class="mb-4">Nahranie QR kódu psa</h1>

    <div class="mb-3">
      <input type="file" accept="image/*" id="qr-input-file" class="form-control">
    </div>

    <div id="result" class="alert d-none"></div>
    <div id="dog-info" class="mt-4"></div>

    <canvas id="canvas"></canvas>
  </div>

  <script>
    function showResult(message, success = true) {
      const result = document.getElementById("result");
      result.className = `alert ${success ? 'alert-success' : 'alert-danger'}`;
      result.innerText = message;
      result.classList.remove("d-none");
    }

    function isValidDogData(data) {
      if (!data || typeof data !== "object") return false;
      const dog = data.Dog;
      if (!dog) return false;
      const requiredFields = ["Name", "Breed", "Class", "Gender", "ChipNumber", "LicenseNumber", "PedigreeNumber", "BirthDate", "Owners"];
      for (const field of requiredFields) {
        if (!(field in dog)) return false;
      }
      if (!Array.isArray(dog.Owners)) return false;
      for (const owner of dog.Owners) {
        const ownerFields = ["FirstName", "LastName", "StreetAndNumber", "PostalCodeAndCity", "Country"];
        for (const f of ownerFields) {
          if (!(f in owner)) return false;
        }
      }
      return true;
    }

    function renderDogInfo(data) {
      const dog = data.Dog;
      let html = `
        <h3>Informácie o psovi</h3>
        <table class="table table-bordered">
          <tbody>
            <tr><th>Meno</th><td>${dog.Name}</td></tr>
            <tr><th>Plemeno</th><td>${dog.Breed}</td></tr>
            <tr><th>Trieda</th><td>${dog.Class}</td></tr>
            <tr><th>Pohlavie</th><td>${dog.Gender}</td></tr>
            <tr><th>Čip</th><td>${dog.ChipNumber}</td></tr>
            <tr><th>Licencia</th><td>${dog.LicenseNumber}</td></tr>
            <tr><th>Rodokmeň</th><td>${dog.PedigreeNumber}</td></tr>
            <tr><th>Dátum narodenia</th><td>${dog.BirthDate}</td></tr>
            <tr><th>Majitelia</th><td><ul class="mb-0">` +
              dog.Owners.map(o => `<li>${o.FirstName} ${o.LastName}, ${o.StreetAndNumber}, ${o.PostalCodeAndCity}, ${o.Country}</li>`).join("") +
            `</ul></td></tr>
          </tbody>
        </table>
      `;
      document.getElementById("dog-info").innerHTML = html;
    }

    document.getElementById("qr-input-file").addEventListener("change", function () {
      const file = this.files[0];
      if (!file) {
        showResult("Prosím, nahraj obrázok s QR kódom.", false);
        return;
      }

      const reader = new FileReader();
      reader.onload = function () {
        const img = new Image();
        img.onload = function () {
          const canvas = document.getElementById("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height);

          if (code) {
            try {
              const parsed = JSON.parse(code.data);
              if (isValidDogData(parsed)) {
                showResult("QR kód úspešne načítaný a validovaný.");
                renderDogInfo(parsed);
              } else {
                showResult("QR kód má neúplnú alebo chybnú štruktúru.", false);
              }
            } catch (e) {
              showResult("QR kód obsahuje neplatný JSON.", false);
            }
          } else {
            showResult("Nepodarilo sa rozpoznať QR kód na obrázku.", false);
          }
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>
