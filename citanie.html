<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dog QR Code Reader</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <style>
    canvas { display: none; }
  </style>
</head>
<body class="bg-light p-4">
  <div class="container">
    <h1 class="mb-4">Upload Dog QR Code</h1>

    <div class="mb-3">
      <input type="file" accept="image/*" id="qr-input-file" class="form-control">
    </div>

    <div id="result" class="alert d-none"></div>
    <div id="dog-info" class="mt-4"></div>

    <canvas id="canvas"></canvas>
  </div>

  <script>
    function showResult(message, success = true) {
      const result = document.getElementById("result");
      result.className = `alert ${success ? 'alert-success' : 'alert-danger'}`;
      result.innerText = message;
      result.classList.remove("d-none");
    }

    function isValidDogData(data) {
      if (!data || typeof data !== "object") return false;
      const dog = data.Dog;
      if (!dog) return false;
      const requiredFields = ["Name", "Breed", "Class", "Gender", "ChipNumber", "LicenseNumber", "PedigreeNumber", "BirthDate", "Owners"];
      for (const field of requiredFields) {
        if (!(field in dog)) return false;
      }
      if (!Array.isArray(dog.Owners)) return false;
      for (const owner of dog.Owners) {
        const ownerFields = ["FirstName", "LastName", "StreetAndNumber", "PostalCodeAndCity", "Country"];
        for (const f of ownerFields) {
          if (!(f in owner)) return false;
        }
      }
      return true;
    }

    function renderDogInfo(data) {
      const dog = data.Dog;
      let html = `
        <h3>Dog Information</h3>
        <table class="table table-bordered">
          <tbody>
            <tr><th>Name</th><td>${dog.Name}</td></tr>
            <tr><th>Breed</th><td>${dog.Breed}</td></tr>
            <tr><th>Class</th><td>${dog.Class}</td></tr>
            <tr><th>Gender</th><td>${dog.Gender}</td></tr>
            <tr><th>Chip Number</th><td>${dog.ChipNumber}</td></tr>
            <tr><th>License Number</th><td>${dog.LicenseNumber}</td></tr>
            <tr><th>Pedigree Number</th><td>${dog.PedigreeNumber}</td></tr>
            <tr><th>Date of Birth</th><td>${dog.BirthDate}</td></tr>
          </tbody>
        </table>

        <h4>Owners</h4>
      `;

      dog.Owners.forEach((owner, index) => {
        html += `
          <div class="card mb-3">
            <div class="card-header">Owner ${index + 1}</div>
            <div class="card-body">
              <p><strong>Name:</strong> ${owner.FirstName} ${owner.LastName}</p>
              <p><strong>Street and Number:</strong> ${owner.StreetAndNumber}</p>
              <p><strong>Postal Code and City:</strong> ${owner.PostalCodeAndCity}</p>
              <p><strong>Country:</strong> ${owner.Country}</p>
            </div>
          </div>
        `;
      });

      document.getElementById("dog-info").innerHTML = html;
    }

    document.getElementById("qr-input-file").addEventListener("change", function () {
      const file = this.files[0];
      if (!file) {
        showResult("Please upload a QR code image.", false);
        return;
      }

      const reader = new FileReader();
      reader.onload = function () {
        const img = new Image();
        img.onload = function () {
          const canvas = document.getElementById("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height);

          if (code) {
            try {
              const parsed = JSON.parse(code.data);
              if (isValidDogData(parsed)) {
                showResult("QR code successfully read and validated.");
                renderDogInfo(parsed);
              } else {
                showResult("QR code structure is invalid or incomplete.", false);
              }
            } catch (e) {
              showResult("QR code contains invalid JSON.", false);
            }
          } else {
            showResult("Unable to detect QR code in the image.", false);
          }
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>
